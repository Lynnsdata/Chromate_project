## SQL Alchemy

- 참고 링크
    - <a href="https://soogoonsoogoonpythonists.github.io/sqlalchemy-for-pythonist/tutorial/">파이썬 개발자를 위한 SQL Alchemy</a>
    - <a href="https://go-for-data.tistory.com/entry/01SQLBulkInsert/">Python에서 대용량 데이터 SQL에 적재(Insert)하기</a>
- 관련 내용
    - 설치해야 할 패키지 명령어 정리
        
        pip install pymysql
        
        pip install sqlalchemy
        
        pip install mysqlclient : 에러 No module named 'MySQLdb' 해결책
        
    - 서버 연결 방법
        - 유저:비밀번호@IP주소:포트번호/DB이름
        
        engine = sqlalchemy.create_engine('mysql://root:1234@127.0.0.1:3306')
        
        - 엔진을 설정한 후 괄호 안에 실행하고 싶은 작업(DDL문)을 입력한다
        
        engine.execute()


## DDL 쿼리문

1. 데이터베이스 생성
    
    “CREATE DATABASE chromate”
    
2. 생성한 데이터베이스 활성화
    
    “USE chromate”
    
3. 테이블 생성 : data type을 지정해서 만들 수 있다
    
    “CREATE TABLE variable ( ID INT AUTO_INCREMENT PRIMARY KEY, Date DATE NOT NULL, Time TIME NOT NULL, Lot INT NOT NULL, ph FLOAT(3,2) NOT NULL, Temp FLOAT(4,2) NOT NULL, Voltage FLOAT(4,2) NOT NULL )”)
    
    - NOT NULL이라고 써주면 NN에 체크가 된다
    - DATE: YYYY-MM-DD
    - TIME: HH-MM-SS
    - FLOAT(4,2) : 소수점 자릿수를 포함해서 4자리
4. 생성한 테이블에 데이터 입력 방법
    
    (1) df.to_sql(name='원하는DB명', con=engine, if_exists='append',index=False)
    
    - <a href=”[https://hongjuzzang.github.io/howto/dataframe_to_mysql/](https://hongjuzzang.github.io/howto/dataframe_to_mysql/)”>링크</a>
    - if_exists : [fail, replace, append] : **테이블이 이미 존재하는 경우** 어떻게 할지에 대한 옵션
    - fail : ValueError 발생
    - append : 존재하는 테이블에 값 저장
        - append의 경우는 기존에 있는 테이블에 저장을 하는 것이어서 저장할 데이터프레임의 길이나 타입이 맞지 않는다면 오류가 난다.
    - replace : 테이블 지우고 새로 생성 후 값 저장
        - replace는 새로 데이터프레임 타입에 맞춰 테이블이 생성되므로 데이터프레임 타입이 object일 때는 mysql에서는 TEXT로 생긴다. dtype옵션을 줘서 타입을 맞춰줄 수 있다.
        - dtype옵션 부여 예시
        
        > dtypesql = {'exclusive':sqlalchemy.types.VARCHAR(10),
                           'cost':sqlalchemy.types.VARCHAR(10),
                           'contractedAt':sqlalchemy.Date(),
                           'createdAt':sqlalchemy.DateTime(),
        }
        df.to_sql(name='variable', con=engine, if_exists='append', index=False,dtype=dtypesql)
        > 
        
    
    (2)  동적으로 만들어서 테이블에 데이터 insert 하기 (성명건 강사님 갈맷길 수업 참고)
    
    - 컬럼명을 동적으로 만들기
        
        > cols = '`,`'.join([str(i) for i in frame_df.columns.tolist()])'.join([str(i) for i in frame_df.columns.tolist()])
        > 
    - 반복문으로 insert 하기
        
        > for i, row in frame_df.iterrows():
             sql = 'INSERT INTO `variable` (`' + cols + '`) VALUES (' + '%s,'*(len(row)-1) + '%s)'
             engine.execute(sql, tuple(row))
        > 
        
        > engine.commit()
        print('DB저장완료!')
        engine.close()
        > 
        
    
    (3)![티스토리로고](https://user-images.githubusercontent.com/108378151/195582279-8f95eb87-dcf1-43fe-9347-a3b3bb528f7c.png)
